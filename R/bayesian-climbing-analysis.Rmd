---
title: "Bayesian estimation of slope of grade scale"
author: Alexei Drummond
date: 13/08/2021
output:
  pdf_document: default
  html_notebook: default
params:
  startDate: "2016-08-01"
  endDate: "2021-08-01"
  filter.by.tickprop.lrp: FALSE
  per.session: TRUE
  min.ascents: 400
  min.failures: 1
  in.path: "~/Git/climbing-grades/data/processed/"
  out.path: "~/Git/climbing-grades/results/aus/"
  ascents.file: "ascents-aus.rds"
  routes.file: "routes-aus.rds" 
  data.set.name: "Australia"
  data.set.name.short: "aus"
---

# Analysis 1

The data was obtained from [thecrag.com](thecrag.com) using the provided API [https://www.thecrag.com/en/article/api](https://www.thecrag.com/en/article/api). 

A summary of the data processing is shown in Table \@ref{tab:data-processing}.

```{r initial-setup, echo=FALSE}
setwd("~/Git/climbing-grades/R")

source("produce-analysis-data.R")
```


```{r produce analysis data, echo=TRUE}
#########################################
# Analysis settings
#########################################

res <- readRDS(paste0(params$in.path,params$ascents.file))
routes <- readRDS(paste0(params$in.path,params$routes.file))

data <- produce.analysis.data(params, res, routes)
```

```{r heatmap, echo=FALSE}
t <- table(data$df$ascent.type, data$df$account.id)

#normalise by column sums
#t <- t/colSums(t)[col(t)]

heatmap(t)
```

```{r mds-plot, echo=FALSE}
library(vegan)

t.routes <- as.data.frame.matrix(table(data$df$account.id, data$df$ascent.type))

nmds_results <- metaMDS(comm = t.routes,  # Define the community data 
                        distance = "bray",       # Specify a bray-curtis distance
                        try = 100)  

plot(nmds_results, type="t")

```

```{r regression-plot, echo=FALSE}
include_graphics(data$regressionpng)
```

The average slope from a simple regression of the log-odds of failure is
```{r}
mean(data$m)
```
The average grade range from a simple regression of the log-odds of failure is
```{r}
summary(data$grade.range)
```

```{r data-processing-table, results = 'asis', echo=FALSE}
##########################################################################################
# Write filter results to table
##########################################################################################
caption <- paste0("Summary of data processing for analysis of ", params$data.set.name, " ascent data.")

label <- paste0("table-data-processing-",params$data.set.name.short);

xt <- xtable(data$filter, caption = caption, label = label)

tablefile <- paste0(data$file.stem, "-processing-table.tex")

print(xt, 
      size="\\fontsize{9pt}{10pt}\\selectfont", 
      include.rownames=FALSE,
      sanitize.colnames.function = function(x) {paste0("{\\bf ",x,"}")}, 
      file=tablefile)

print(xt, sanitize.colnames.function = function(x) {paste0("{\\bf ",x,"}")})
```

The final processed data set includes a total of 

```{r }
data.summary <- data.frame(label=c("Climbers", "Ascents","Total Months"), value=c(data$d$C, data$d$N, data$d$P))

print(xtable(data.summary))
```

Not all climbers made ascents during all months. 

The total number of climber months is
```{r}
sum(data$d$maxPage - data$d$minPage + 1)
```

The average number of ascents per climber per active month is
```{r}
data$d$N / sum(data$d$maxPage - data$d$minPage + 1)
```

```{r stan-analysis, echo=FALSE}
##########################################################################################
# RUN BAYESIAN INFERERENCE
##########################################################################################

fit1 <- run.stan.climbing.model(data$d)
```


```{r bayesian-analysis-figure, echo=FALSE}
 pngname <- paste0(data$file.stem, "-posterior.png")
 
 ylab <- "Flash Grade";
 if (params$per.session) {
   ylab <- "Session Grade"
 }
 
 plot.stan.climbing.results(params$startDate, params$endDate, fit1, data$d, pngname, ylab=ylab);
 
 include_graphics(pngname)
```


```{r save-results, echo=FALSE}
fit.file.name <- paste0(data$file.stem, ".rds")

fit1@stanmodel@dso <- new("cxxdso")
saveRDS(fit1, file=fit.file.name)
rm(fit1)

data.file.name <- paste0(data$file.stem, "-data.rds")
saveRDS(data, file=data.file.name)
```

```{r load-results, echo=FALSE}
fit.file.name <- paste0(data$file.stem, ".rds")

fit <- readRDS(file=fit.file.name)
df <- as.data.frame(fit)

```

```{r mean-posterior, echo=FALSE}

q <- quantile(df$m, c(0.025, 0.5, 0.975))

print(q)

print(exp(q))
```
```{r mean-posterior-grades, echo=FALSE}



hist(mean.grade)

hist(data$m)


```


```{r}
summary  <- table(data$df$account.id, data$df$ascent.type)

summary(summary[,"dog"]+summary[,"attempt"]+summary[,"working"]+summary[,"retreat"])

fail.fraction <- (summary[,"dog"]+summary[,"attempt"]+summary[,"working"]+summary[,"retreat"])/rowSums(summary)

summary(fail.fraction)

```

```{r}



plot(data$m, fail.fraction)
```